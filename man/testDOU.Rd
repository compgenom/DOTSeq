% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/posthoc.R
\name{testDOU}
\alias{testDOU}
\title{Compute Differential ORF Usage (DOU) Contrasts Using Estimated Marginal Means}
\usage{
testDOU(
  sumExp,
  contrasts_method = "revpairwise",
  nullweight = 500,
  verbose = TRUE
)
}
\arguments{
\item{sumExp}{A SummarizedExperiment object containing fitted model objects,
typically stored in \code{rowData(sumExp)[['fitDOUModels']]}.}

\item{contrasts_method}{Character string specifying the method for computing contrasts.
Default is \code{"revpairwise"}.}

\item{nullweight}{Numeric. Prior weight on the null hypothesis for empirical Bayes shrinkage.
Higher values yield more conservative lfsr estimates. Default is \code{500}.}

\item{verbose}{Logical. If \code{TRUE}, prints progress messages. Default is \code{TRUE}.}
}
\value{
A \strong{SummarizedExperiment} object (the input \code{sumExp} or \code{m$sumExp})
with two new \code{S4Vectors::DataFrame} objects stored in its \code{metadata} slot.
These tables contain the long-format results for all computed contrasts:
\describe{
\item{\code{interaction_results}}{A long-format \code{S4Vectors::DataFrame} containing the
\strong{Differential ORF Usage (DOU) effect sizes} (Ribo-seq contrast minus RNA-seq contrast)
for all computed interaction contrasts. Columns include \code{contrast},
the full set of shrunken and unshrunken metrics (e.g., \code{betahat}, \code{sebetahat},
\code{WaldPadj}, \code{PosteriorMean}, \code{lfsr}).}
\item{\code{strategy_results}}{A long-format \code{S4Vectors::DataFrame} containing the
\strong{strategy-specific effect sizes} (e.g., estimates for Ribo-seq only) for all computed contrasts.
Columns include \code{strategy} (e.g., "ribo", "rna"), \code{contrast},
and the full set of shrunken and unshrunken metrics.}
}
}
\description{
Performs Differential ORF Usage (DOU) analysis by computing contrasts between ribosome profiling
and RNA-seq modalities using estimated marginal means (EMMs) from fitted GLMM models.
Supports both interaction-specific and strategy-specific contrasts, and applies empirical Bayes
shrinkage via the \code{ashr} package to stabilize effect size estimates.
}
\details{
The results for post hoc contrasts are stored in a long format via explicit \code{contrast} and/or
\code{strategy} columns. Non-converged models are omitted.
}
\examples{
# Load \link[SummarizedExperiment]{SummarizedExperiment} to enable subsetting 
# and access to components like rowRanges and rowData.
library(SummarizedExperiment)

# Read in count matrix, condition table, and annotation files.
dir <- system.file("extdata", package = "DOTSeq")

cnt <- read.table(
  file.path(dir, "featureCounts.cell_cycle_subset.txt.gz"), 
  header=TRUE, 
  comment.char ='#'
  )
names(cnt) <- gsub(".*(SRR[0-9]+).*", "\\\\1", names(cnt))

flat <- file.path(dir, "gencode.v47.orf_flattened_subset.gtf.gz")
bed <- file.path(dir, "gencode.v47.orf_flattened_subset.bed.gz")

meta <- read.table(file.path(dir, "metadata.txt.gz"))
names(meta) <-  c("run","strategy","replicate","treatment","condition")
cond <- meta[meta$treatment=="chx",] # extract only samples processed using cyclohexamide 
cond$treatment <- NULL # remove the treatment column

# Create \link[SummarizedExperiment]{SummarizedExperiment} objects.
# These objects can be used as input for \code{\link{DOTSeq}} and \code{\link{fitDOU}}.
m <- DOTSeqDataSet(
  count_table = cnt, 
  condition_table = cond, 
  flattened_gtf = flat, 
  bed = bed
  )
 
# Keep ORFs where all replicates in at least one condition pass min_count.
# Single-ORF genes are removed.
m$sumExp <- m$sumExp[rowRanges(m$sumExp)$is_kept == TRUE, ]

# Randomly sample 100 ORFs for \code{\link{fitDOU}}.
n <- 100 
set.seed(42)
random_rows <- sample(seq_len(nrow(m$sumExp)), size = n)

# Subset the SummarizedExperiment object
m$sumExp <- m$sumExp[random_rows, ]

# Model fitting using \code{\link{fitDOU}}.
rowData(m$sumExp)[["DOUResults"]] <- fitDOU(
  countData = assay(m$sumExp),
  orf2gene = rowData(m$sumExp), 
  anno = colData(m$sumExp),
  formula = ~condition * strategy,
  emm_specs = ~condition * strategy,
  dispersion_modeling = "auto",
  lrt = FALSE,
  optimizers = FALSE,
  diagnostic = FALSE,
  parallel = list(n=4L, autopar=TRUE),
  seed = 42,
  verbose = TRUE
)

# Run post hoc contrasts, Wald tests, and effect size shrinkage
m$sumExp <- testDOU(m$sumExp, verbose = TRUE)

}
